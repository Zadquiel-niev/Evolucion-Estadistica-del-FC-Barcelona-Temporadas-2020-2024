---
title: "ANÁLSIS ESTADÍSTICO DEL FC BARCELONA EN LAS TEMPORADAS 2020-2024"
author: "JAguirre"
date: "`r Sys.Date()`"
output: pdf_document
---

# Planteamiento de Problema

El FC Barcelona es una de las instituciones deportivas más importantes del mundo. Su rendimiento en La Liga depende de muchos factores, desde el 2020 hasta 2024, el equipo ha cambiado mucho, se ha pasado de buscar entender qué pasa, a ver qué funciona mejor. 

# Justificación del Problema

El fútbol actual depende cada vez más del análisis de datos, para un club como el Barcelona, con altas expectativas y un estilo de juego definido, usar estadísticas básicas es muy importante para:

- Detectar fortalezas y debilidades en diferentes situaciones, como partidos en casa o fuera.

- Mejorar la alineación, las estrategias según los rivales y las circunstancias.

- Medir cómo influyen los jugadores importantes en la creación de juego y en marcar goles, también defender bien.

- De cambio Entender el rendimiento en un momento tras la era Messi y en medio de problemas económicos.

- Este análisis ayudará a entender cómo ha evolucionado el equipo más allá de las opiniones personales, usando datos reales de La Liga.

# Objetivo General

Evaluar la evolución táctica y de rendimiento ofensivo del Fútbol Club Barcelona durante las temporadas 2020 a 2024, mediante el análisis estadístico y la visualización de métricas avanzadas como la Posesión (poss), Goles Esperados (xg), Goles esperados en contra (xga), Goles (gf), Goles en contra (ga), Resultado de los partidos en casa y afuera más Formaciones Tácticas. Y ver si esto ayudó al FC Barcelona a levantarse en una de sus peores temporadas en la historia (2020-2021)

## Objetivos Específicos
- Cuantificar la tendencia anual de las métricas clave de rendimiento (Goles a Favor, Goles en Contra, y Porcentaje de Posesión) para determinar la dirección de la evolución del modelo de juego del equipo.
- Establecer la relación de correlación (fuerza y dirección) entre el Porcentaje de Posesión y la Eficiencia de Oportunidades (poss, xg, xga) a nivel de partido, viendo los resultados por temporada.
- Determinar si existe una diferencia estadísticamente significativa en el Puntos por temporadas obtenidos por el club en función de las Formaciones Tácticas (formation) más utilizadas en cada temporada.

# Breve Historia

El FC Barcelona cambió mucho entre 2020 y 2024, después de que Messi se fue en 2021, el club pasó por estos cambios:

- Cambio en el entrenador: De Ronald Koeman a Xavi Hernández, si hubo cambios a nivel de juego.

- Promoción de jóvenes: Llegaron Pedri, Gavi, Lamine Yamal y fichajes como Lewandowski, Raphinha y Koundé entre otros.

- Cambio en la estrategia: Dejaron de usar solo el 3-5-2 y probaron formaciones más variadas como el 4-2-3-1 y el 4-3-3 con doble pivote.

- Resultados: Ganaron mucho en La Liga, pero tuvieron problemas en la Champions League en algunos momentos (todavía).

Este período explica los datos que vemos, Se trata de cambios y adaptaciones constantes.

# Marco Metodológico

## Fuente de Datos y Tiempo

Usamos el conjunto de datos completo matches_full_la_liga.csv. Este conjunto tiene registros de partidos de La Liga desde 2020-2021 hasta 2024-2025. Tiene 4,319 filas. Es una base de datos que muestra la competencia del fútbol español en ese periodo. Las variables incluyen datos cuantitativos y cualitativos. Algunas variables importantes son:

- Resultados: gf (goles a favor), ga (goles en contra), result (resultado)
- Rendimiento: poss (posesión), sh (tiros), sot (tiros a puerta), xg (goles esperados),
 xga (Goles esperado en contra) dist (distancia en total recorrida en el partido)
- Variables de contexto: formación (formación), attendance (asistencia), venue (localía)

## Variables y Análisis

El estudio tiene cuatro partes principales, cada una ayuda a entender el rendimiento del equipo:
Rendimiento en Casa y Fuera: Comparamos el equipo cuando juega en su campo y cuando juega afuera, goles y goles en contra, esto muestra si el equipo actúa diferente según el lugar de juego.
Posesión y Goles:  Evaluamos la relación entre cuánto controla el balón, las oportunidades y los goles. Esto nos ayuda a entender si la posesión lleva a más goles esperados y si el equipo es eficiente en ataque.
Formaciones y Tácticas: Analizamos cómo cambia la estrategia del equipo, revisión de formaciones y rotaciones del plantel en cada temporada, esto revela cómo evoluciona el estilo de juego.

# Infraestructura y Herramientas

Usamos tecnología para analizar los datos. Combinamos estadísticas con visualizaciones:

R, Rmarkdown: Aquí es donde hicimos nuestro PDF, respondiendo las preguntas en el planteamiento delo problema y nuestras Investigaciones del trabajo sobre la Evolución del Barcelona 2020-2024.
Python, Pandas/Plotly/Matplotlib: Desarrollamos una aplicación web (Streamlit) para ver los datos, la interfaz permite filtrar la información y ver patrones dinámicamente, y lo más importante, mostrar nuestros gráficos interactivos sobre nuestro trabajo e investigaciones.
¡Perfecto! El ajuste es clave para la seriedad del trabajo. Tienes razón al ser más específico con las hipótesis; ellas son la base de tu análisis estadístico.
Aquí tienes la formalización de la sección metodológica, incluyendo los Objetivos y una propuesta de Hipótesis Específicas que puedes utilizar, todas vinculadas a las variables de tu base de datos (matches_full_LaLiga.csv).

# Proceso de Trabajo

El trabajo tiene dos fases:

- Preparación de datos: Se realizará la filtración de los registros de la base de datos matches_full_LaLiga.csv correspondientes únicamente al club FC Barcelona para el rango de temporadas 2020-2024.
- Visualización avanzada: Gráficos de dispersión, diagramas de barras y Gráficos de Líneas, Esto ayuda a entender mejor los datos y responder nuestras preguntas planteadas.

Este método garantiza resultados confiables y útiles. Proporciona información clara para nosotros y también quienes toman decisiones en el club, desde técnicos hasta directivos.


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE, fig.align = 'center')

library(dplyr)
library(ggplot2)
library(corrplot)
library(readr)
library(plotly)
library(patchwork)

matches_full_la_liga <-read_csv('matches_full_la_liga.csv')

# Filtrar datos del Barcelona
barca_data <- matches_full_la_liga %>% 
  filter(team == "Barcelona", season %in% c(2021, 2022, 2023, 2024, 2025))
```

```{r tabla1, echo=FALSE, message=FALSE, warning=FALSE}
# El cálculo original de tendencias_anuales
tendencias_anuales <- barca_data %>%
  group_by(season) %>%
  summarise(
    partidos_jugados = n(),
    goles_favor = sum(gf, na.rm = TRUE),
    goles_contra = sum(ga, na.rm = TRUE),
    promedio_gf = mean(gf, na.rm = TRUE),
    promedio_ga = mean(ga, na.rm = TRUE),
    promedio_posesion = mean(poss, na.rm = TRUE),
    promedio_xg = mean(xg, na.rm = TRUE),
    promedio_xga = mean(xga, na.rm = TRUE),
    victorias = sum(result == "W", na.rm = TRUE),
    empates = sum(result == "D", na.rm = TRUE),
    derrotas = sum(result == "L", na.rm = TRUE),
    puntos = (victorias * 3) + empates
  ) %>%
  mutate(
    efectividad = (puntos / (partidos_jugados * 3)) * 100,
    diferencia_goles = goles_favor - goles_contra
  )

# --- TABLA 1: Rendimiento General y Resultados ---
tabla1_rendimiento <- tendencias_anuales %>%
  select(
    season, partidos_jugados, victorias, empates, derrotas, puntos, efectividad
  )

knitr::kable(tabla1_rendimiento, 
             caption = "Tabla 1: Rendimiento General y Puntos por Temporada",
             digits = 1)
```

Al examinar la Tabla 1 (Rendimiento General) a través de las temporadas, el primer punto de análisis es la estabilidad de los puntos y la efectividad. Si observamos una caída notable en la temporada 2021/2022 (coincidiendo con la reestructuración post-Messi) seguida de un repunte significativo en 2022/2023, esto indica un punto de inflexión en el rendimiento. Por ejemplo, una efectividad del 65% en 2022/2023, en comparación con un 55% en 2021/2022, señalaría que el equipo mejoró su capacidad de capitalizar partidos, revirtiendo la tendencia de más derrotas por temporada y consolidando un mayor número de victorias. Finalmente, si la temporada 2024/2025 muestra un ligero descenso en efectividad a pesar de mantener un alto número de victorias (posiblemente con más empates), esto sugeriría una meseta o un pequeño retroceso en la capacidad del equipo para cerrar partidos clave, lo que se debe investigar con las métricas subyacentes de la Tabla 2.

```{r tabla2, echo=FALSE, message=FALSE, warning=FALSE}
# --- TABLA 2: Métricas de Goles y Posesión ---
tabla2_metricas <- tendencias_anuales %>%
  select(
    season, promedio_gf, promedio_ga, diferencia_goles, 
    promedio_posesion, promedio_xg, promedio_xga
  ) %>%
  rename(
    'Dif. G.' = diferencia_goles,
    'Prom. Posesión (%)' = promedio_posesion,
    'Prom. G. a Favor' = promedio_gf,
    'Prom. G. en Contra' = promedio_ga
  )


knitr::kable(tabla2_metricas, 
             caption = "Tabla 2: Promedios de Goles, Posesión y XG por Temporada",
             digits = 2) # Usamos 2 decimales para los promedios
```

El análisis de la Tabla 2 (Métricas Avanzadas) se centrar en la relación entre el estilo de juego (promedio_posesion) y la eficiencia. Si el promedio_posesion se mantiene en un nivel consistentemente alto (e.g., por encima del 62%) en todas las temporadas, esto confirma la adhesión al modelo de control de balón. La verdadera tendencia reside en la eficiencia:

Eficiencia Ofensiva (promedio_gf vs. promedio_xg): Si, en la temporada 2022/2023 (la de mayor efectividad de la Tabla 1), encontramos que promedio_gf es significativamente mayor que promedio_xg, esto sugiere que la diferencia de goles se impulsó por una finalización clínica o una racha de "suerte" ofensiva (sobre-rendimiento). Por el contrario, si en 2024/2025 el promedio_xg es mayor que el promedio_gf, indica que el equipo está creando buenas oportunidades, pero no las está capitalizando, lo que explica una posible caída en efectividad.

Solidez Defensiva (promedio_ga vs. promedio_xga): Un equipo defensivamente sólido mostrará una promedio_ga consistentemente inferior a promedio_xga. Si esta brecha se amplía en las temporadas exitosas, sugiere que el portero y la defensa están salvando más goles de los esperados (sub-rendimiento del rival). Sin embargo, si en la temporada con baja efectividad la métrica promedio_ga se acerca o supera a promedio_xga, esto señala que la defensa o el portero están rindiendo al nivel esperado o incluso por debajo, lo que resulta en un aumento de los goles concedidos.

```{r tendencias, message=FALSE, warning=FALSE, include=FALSE}

tendencias_anuales <- barca_data %>%
  group_by(season) %>%
  summarise(
    partidos_jugados = n(),
    goles_favor = sum(gf, na.rm = TRUE),
    goles_contra = sum(ga, na.rm = TRUE),
    promedio_gf = mean(gf, na.rm = TRUE),
    promedio_ga = mean(ga, na.rm = TRUE),
    promedio_posesion = mean(poss, na.rm = TRUE),
    promedio_xg = mean(xg, na.rm = TRUE),
    promedio_xga = mean(xga, na.rm = TRUE),
    victorias = sum(result == "W", na.rm = TRUE),
    empates = sum(result == "D", na.rm = TRUE),
    derrotas = sum(result == "L", na.rm = TRUE),
    puntos = (victorias * 3) + empates
  ) %>%
  mutate(
    efectividad = (puntos / (partidos_jugados * 3)) * 100,
    diferencia_goles = goles_favor - goles_contra
  )

# Mostrar la tabla de resumen (usa knitr::kable para mejor formato en PDF)
knitr::kable(tendencias_anuales, caption = "Resumen de Tendencias Anuales del FC Barcelona")
```


```{r grafico, echo=FALSE, message=FALSE, warning=FALSE}
g1 <- ggplot(tendencias_anuales, aes(x = as.factor(season))) + # Convertir season a factor para eje X discreto
  geom_line(aes(y = promedio_gf, color = "Goles a Favor", group = 1), size = 1.5) +
  geom_line(aes(y = promedio_ga, color = "Goles en Contra", group = 1), size = 1.5) +
  geom_point(aes(y = promedio_gf), size = 3, color = "#004D98") +
  geom_point(aes(y = promedio_ga), size = 3, color = "#A50044") +
  labs(title = "Evolución Ofensiva vs. Defensiva",
       subtitle = "Promedio de Goles por Partido",
       x = "Temporada", y = "Goles por Partido",
       color = "Métrica") +
  scale_color_manual(values = c("Goles a Favor" = "#004D98", 
                                "Goles en Contra" = "#A50044")) +
  theme_minimal() +
  theme(legend.position = "bottom")

# Pega el código del gráfico g2 aquí
g2 <- ggplot(tendencias_anuales, aes(x = as.factor(season))) + # Convertir season a factor
  geom_col(aes(y = promedio_posesion, fill = promedio_posesion), alpha = 0.8) +
  geom_line(aes(y = efectividad, color = "Efectividad (%)", group = 1), size = 1.5) +
  geom_point(aes(y = efectividad), size = 3, color = "#FFD700") +
  scale_y_continuous(sec.axis = sec_axis(~./1, name = "Efectividad (%)")) +
  labs(title = "Posesión y Efectividad por Temporada",
       x = "Temporada", y = "Posesión (%)") +
  scale_fill_gradient(low = "#87CEEB", high = "#004D98", name = "Posesión (%)") +
  scale_color_manual(values = c("Efectividad (%)" = "#FFD700")) +
  theme_minimal()

# Usar patchwork para combinar los gráficos (o simplemente mostrarlos por separado)
# print(g1 / g2) # Combina en una columna
print(g1)
print(g2)
```

```{r matris, echo=FALSE, message=FALSE, warning=FALSE}

correlacion_general <- barca_data %>%
  select(poss, xg, xga, gf, ga, sh, sot) %>%
  cor(use = "complete.obs")

# Visualizar la matriz de correlación
corrplot::corrplot(correlacion_general, 
                   method = "color", 
                   type = "upper", 
                   order = "hclust",
                   addCoef.col = "black", 
                   tl.col = "black", 
                   tl.srt = 45, 
                   diag = FALSE,
                   title = "Correlación General de Métricas (2021-2025)",
                   mar=c(0,0,1,0)) # Ajuste para el título
```

```{r grfico2, echo=FALSE, message=FALSE, warning=FALSE}
eficiencia_posesion <- barca_data %>%
  mutate(
    categoria_posesion = cut(poss, 
                             breaks = c(0, 50, 60, 70, 100),
                             labels = c("Baja (0-50%)", "Media (50-60%)", "Alta (60-70%)", "Muy Alta (70%+)")
                             , include.lowest = TRUE) # Incluir el 100%
  ) %>%
  group_by(categoria_posesion) %>%
  summarise(
    partidos = n(),
    promedio_gf = mean(gf, na.rm = TRUE),
    promedio_xg = mean(xg, na.rm = TRUE),
    # Prevenir división por cero si xg fuera 0, aunque improbable
    eficiencia_ataque = mean(gf / xg, na.rm = TRUE), 
    puntos_por_partido = mean(ifelse(result == "W", 3, 
                                     ifelse(result == "D", 1, 0)), na.rm = TRUE)
  )

ggplot(eficiencia_posesion, aes(x = categoria_posesion, y = puntos_por_partido, fill = categoria_posesion)) +
  geom_col() +
  labs(title = "Puntos por Partido vs. Categoría de Posesión",
       subtitle = "¿La Posesión Alta se Traduce en Mejores Resultados?",
       x = "Categoría de Posesión",
       y = "Puntos Promedio por Partido") +
  scale_fill_brewer(palette = "Blues") +
  theme_minimal()
```

